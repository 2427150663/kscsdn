<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>商品列表</title>
  <link rel="stylesheet" href="css/main.css" />
  <link rel="stylesheet" href="css/mescroll.min.css">
</head>

<body style=" background:#000052">
  <div id="goodsList" class="mescroll">
    <header>
      <div class="top">
        <div class="title">
          可兑换商品
        </div>
      </div>
    </header>
    <section id="mess">
      <div class="con">
        <ul id="ulu">
        </ul>
      </div>
    </section>
  </div>
</body>
<script src="js/main.js"></script>
<script src="js/mescroll.min.js"></script>
<script>
  //创建MeScroll对象,内部已默认开启下拉刷新,自动执行up.callback,重置列表数据;
  var mescroll = new MeScroll("goodsList", {
    down: {
      auto: false, //是否在初始化完毕之后自动执行下拉回调callback; 默认true
      callback: downCallback //下拉刷新的回调
    },
    up: {
      auto: true, //初始化完毕,是否自动触发上拉加载的回调
      isBoth: true, //上拉加载时,如果滑动到列表顶部是否可以同时触发下拉刷新;默认false,两者不可同时触发; 这里为了演示改为true,不必等列表加载完毕才可下拉;
      callback: upCallback, //上拉加载的回调
      isBounce: false, //此处禁止ios回弹,解析(务必认真阅读,特别是最后一点): http://www.mescroll.com/qa.html#q10
      lazyLoad: {
        use: true // 是否开启懒加载,默认false
      },
      page: {
        num: 0, // 当前页码,默认0,回调之前会加1,即callback(page)会从1开始
        size: 10 // 每页数据的数量
      },
      toTop: { //配置回到顶部按钮
        src: "./img/mescroll-totop.png", //默认滚动到1000px显示,可配置offset修改
        offset: 800
      }
    }
  });
  /*下拉刷新的回调 */
  function downCallback() {
    mescroll.options.up.page = {
      "num": 1,
      "size": 10,
      "time": null
    }
    //联网加载数据
    getListDataFromNet(
      mescroll.options.up.page.num,
      mescroll.options.up.page.size,
      function (curPageData) {
        mescroll.endSuccess(curPageData.length);
        setListData(curPageData, false);
      },
      function () {
        mescroll.endErr();
      }
    );
  }

  let index = 1;
  /*上拉加载的回调 page = {num:1, size:10}; num:当前页 从1开始, size:每页数据条数 */
  function upCallback(page) {
    //联网加载数据
    getListDataFromNet(
      page.num,
      page.size,
      function (curPageData) {
        mescroll.endSuccess(curPageData.length);
        setListData(curPageData, true);
      },
      function () {
        mescroll.endErr();
      }
    );
  }

  /*设置列表数据*/
  function setListData(curPageData, isAppend) {
    var listDom = document.getElementById("ulu");
    let kt = "";
    console.log(curPageData.length)
    curPageData.forEach((x, i) => {
      var htm = ` <div class="conTop">
                            <img imgurl="https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1567488783070&di=d11872f925037c140520a65dd5bc2a47&imgtype=0&src=http%3A%2F%2Fwww.lovehhy.net%2Flib%2Fimg%2F74826%2F203678_1732237563.jpg"
                                alt="">
                        </div>
                        <div class="conTitle">
                            ${index * 10 - 10 + i + 1} 安琪月饼中秋节巧克力冰皮月饼
                        </div>
                  `;
      kt += `<li onclick="window.location.href='goodsDetails.html?id=' + ${i + 1}'">
            <div class="conTop">
              <img
              imgurl="https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1567488783002&di=e4ebc9538eac78e5d16e647268c93f19&imgtype=0&src=http%3A%2F%2Fimg.juimg.com%2Ftuku%2Fyulantu%2F121017%2F240425-12101G9591263.jpg"
                alt=""  src="img/load.png"/>
            </div>
            <div class="conTitle">
              ${index * 10 - 10 + i + 1}华美月饼巧克力冰皮月饼
            </div>
          </li>`;
      var liDom = document.createElement("li");
      liDom.onclick = function () {
        window.location.href = 'goodsDetails.html?id=' + (i + 1);
      }
      if (isAppend) {
        liDom.innerHTML = htm;
        listDom.appendChild(liDom);
      }
    });
    if (!isAppend) {
      listDom.innerHTML = kt;
    }
  }

  function getListDataFromNet(
    pageNum,
    pageSize,
    successCallback,
    errorCallback
  ) {
    index = pageNum;
    fetch(
      `http://yapi.demo.qunar.com/mock/70481/api/theScreenOnThe/getTaskdetaillIST?pageIndex=${pageNum}&pageSize=${pageSize}`
    )
      .then(response => response.json())
      .then(res => {
        let arr = res.data.list;
        setTimeout(() => {
          if (pageNum > 2) {
            arr = [];
          }
          console.log(arr)
          successCallback(arr);
        }, 500);
      });
  }
</script>

</html>